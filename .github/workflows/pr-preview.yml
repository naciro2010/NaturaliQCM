name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

jobs:
  build-preview:
    name: Build and Deploy PR Preview
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Enable web support
        run: flutter config --enable-web

      - name: Build web for preview
        run: flutter build web --release --base-href="/"

      - name: Deploy to Netlify Preview
        uses: nwtgck/actions-netlify@v2.1
        with:
          publish-dir: './build/web'
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          alias: pr-${{ github.event.pull_request.number }}
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://pr-${prNumber}--naturaliqcm.netlify.app`;

            const comment = `## ðŸš€ Preview Deployment

            Your PR has been successfully deployed to Netlify!

            ðŸ”— **Preview URL**: ${previewUrl}

            This preview will be automatically updated when you push new commits to this PR.

            ---

            ### Build Info
            - ðŸ“¦ Commit: \`${context.sha.substring(0, 7)}\`
            - ðŸ”¨ Build: [View logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-preview-${{ github.event.pull_request.number }}
          path: build/web/
          retention-days: 3
